# CAN Protocol Documentation

## 概述
本文檔記錄了車輛CAN匯流排上所有訊號的編碼和解碼方式，包括GPS、加速器、逆變器等系統的通訊協議。

## 目錄
- [時間戳協議](#時間戳協議)
- [Ecumaster GPS協議](#ecumaster-gps協議)
- [Ecumaster GPS擴展協議](#ecumaster-gps擴展協議)
- [蓄電池系統協議](#蓄電池系統協議)
- [逆變器系統協議](#逆變器系統協議)

---

## 時間戳協議

### 0x100 - Timestamp
**用途**: 系統時間同步
**格式**: Little-endian
**資料長度**: 6 bytes

| 字節位置 | 數據類型 | 描述 | 單位 | 範圍 |
|---------|---------|------|------|------|
| 0-3 | uint32 | 自午夜以來的毫秒數 | ms | 0-86400000 |
| 4-5 | uint16 | 自1984年以來的天數 | days | 0-65535 |

**解碼公式**:
```
base_timestamp = 441763200  # 1984-01-01 00:00:00 UTC
total_seconds = base_timestamp + (days_since_1984 * 86400) + (ms_since_midnight / 1000.0)
actual_time = datetime.fromtimestamp(total_seconds)
```

---

## Ecumaster GPS協議

### 0x400 - GPS基本資訊
**用途**: GPS座標資料
**格式**: Little-endian
**資料長度**: 8 bytes

| 字節位置 | 數據類型 | 描述 | 乘數 | 單位 | 範圍 |
|---------|---------|------|------|------|------|
| 0-3 | int32 | 緯度 | 1/10^7 | 度 | ±90.0 |
| 4-7 | int32 | 經度 | 1/10^7 | 度 | ±180.0 |

**解碼公式**:
```
latitude = lat_raw / 10^7
longitude = lon_raw / 10^7
```

### 0x401 - GPS擴展資訊
**用途**: GPS速度、高度和狀態
**格式**: Little-endian
**資料長度**: 8 bytes

| 字節位置 | 數據類型 | 描述 | 係數 | 單位 | 範圍 |
|---------|---------|------|------|------|------|
| 0-1 | int16 | 速度 | 0.036 | km/h | ±1179 |
| 2-3 | int16 | 高度 | 1 | m | ±32767 |
| 4 | uint8 | 衛星數量 | 1 | 個 | 0-255 |
| 5 | uint8 | 框架狀態字節 | - | - | - |
| 6 | uint8 | GPS狀態 | - | - | - |
| 7 | uint8 | 保留 | - | - | - |

**解碼公式**:
```
speed_kmh = speed_raw * 0.036
altitude_m = alt_raw
gps_frame_idx = frame_status_byte & 0x0F
empty_frame_idx = (frame_status_byte >> 4) & 0x0F
gps_status = status_byte & 0x07
```

### 0x402 - 航向和角速度
**用途**: 航向角和XY軸角速度
**格式**: Little-endian
**資料長度**: 8 bytes

| 字節位置 | 數據類型 | 描述 | 係數 | 單位 | 範圍 |
|---------|---------|------|------|------|------|
| 0-1 | uint16 | 運動航向 | 1 | 度 | 0-360 |
| 2-3 | uint16 | 車輛航向 | 1 | 度 | 0-360 |
| 4-5 | int16 | X軸角速度 | 0.01 | °/s | ±250 |
| 6-7 | int16 | Y軸角速度 | 0.01 | °/s | ±250 |

**解碼公式**:
```
heading_motion = heading_motion_raw  # 度
heading_vehicle = heading_vehicle_raw  # 度
x_angle_rate = x_angle_rate_raw * 0.01  # °/s
y_angle_rate = y_angle_rate_raw * 0.01  # °/s
```

### 0x403 - Z角速度和加速度
**用途**: Z軸角速度和三軸加速度
**格式**: Little-endian
**資料長度**: 8 bytes

| 字節位置 | 數據類型 | 描述 | 係數 | 單位 | 範圍 |
|---------|---------|------|------|------|------|
| 0-1 | int16 | Z軸角速度 | 0.01 | °/s | ±250 |
| 2-3 | int16 | X軸加速度 | 0.01 | g | ±4 |
| 4-5 | int16 | Y軸加速度 | 0.01 | g | ±4 |
| 6-7 | int16 | Z軸加速度 | 0.01 | g | ±4 |

**解碼公式**:
```
z_angle_rate = z_angle_rate_raw * 0.01  # °/s
x_accel = x_accel_raw * 0.01  # g
y_accel = y_accel_raw * 0.01  # g
z_accel = z_accel_raw * 0.01  # g
```

---

## Ecumaster GPS擴展協議

### 0x404 - X方向線性速度
**用途**: X軸方向的詳細速度資訊
**格式**: Little-endian
**資料長度**: 8 bytes

| 字節位置 | 數據類型 | 描述 | 係數 | 單位 | 範圍 |
|---------|---------|------|------|------|------|
| 0-3 | int32 | X方向速度 | 0.001 | m/s | ±2000 |
| 4-7 | - | 保留 | - | - | - |

### 0x405 - Y方向線性速度
**用途**: Y軸方向的詳細速度資訊
**格式**: Little-endian
**資料長度**: 8 bytes

| 字節位置 | 數據類型 | 描述 | 係數 | 單位 | 範圍 |
|---------|---------|------|------|------|------|
| 0-3 | int32 | Y方向速度 | 0.001 | m/s | ±2000 |
| 4-7 | - | 保留 | - | - | - |

### 0x406 - Z方向線性速度
**用途**: Z軸方向的詳細速度資訊
**格式**: Little-endian
**資料長度**: 8 bytes

| 字節位置 | 數據類型 | 描述 | 係數 | 單位 | 範圍 |
|---------|---------|------|------|------|------|
| 0-3 | int32 | Z方向速度 | 0.001 | m/s | ±2000 |
| 4-7 | - | 保留 | - | - | - |

### 0x407 - X軸角速度詳細
**用途**: X軸角速度的高精度資訊
**格式**: Little-endian
**資料長度**: 8 bytes

| 字節位置 | 數據類型 | 描述 | 係數 | 單位 | 範圍 |
|---------|---------|------|------|------|------|
| 0-3 | int32 | X軸角速度 | 0.001 | rad/s | ±2000 |
| 4-7 | - | 保留 | - | - | - |

### 0x408 - Y軸角速度詳細
**用途**: Y軸角速度的高精度資訊
**格式**: Little-endian
**資料長度**: 8 bytes

| 字節位置 | 數據類型 | 描述 | 係數 | 單位 | 範圍 |
|---------|---------|------|------|------|------|
| 0-3 | int32 | Y軸角速度 | 0.001 | rad/s | ±2000 |
| 4-7 | - | 保留 | - | - | - |

### 0x409 - Z軸角速度詳細
**用途**: Z軸角速度的高精度資訊
**格式**: Little-endian
**資料長度**: 8 bytes

| 字節位置 | 數據類型 | 描述 | 係數 | 單位 | 範圍 |
|---------|---------|------|------|------|------|
| 0-3 | int32 | Z軸角速度 | 0.001 | rad/s | ±2000 |
| 4-7 | - | 保留 | - | - | - |

### 0x40A - 總速度大小
**用途**: 三維空間中的總速度大小
**格式**: Little-endian
**資料長度**: 8 bytes

| 字節位置 | 數據類型 | 描述 | 係數 | 單位 | 範圍 |
|---------|---------|------|------|------|------|
| 0-3 | int32 | 總速度大小 | 0.001 | m/s | 0-2000 |
| 4-7 | - | 保留 | - | - | - |

**解碼公式**:
```
velocity_magnitude = vmag_raw / 1000.0  # m/s
speed_kmh = velocity_magnitude * 3.6  # km/h
```

---

## 蓄電池系統協議

### 0x190 - 電池電壓
**用途**: 電池單體電壓監測
**格式**: Little-endian
**資料長度**: 8 bytes

| 字節位置 | 數據類型 | 描述 | 係數 | 單位 | 範圍 |
|---------|---------|------|------|------|------|
| 0 | uint8 | 電池組索引 | 1 | - | 0-255 |
| 1-7 | uint8 | 電池電壓 | 0.02 | V | 0-5.1 |

**解碼公式**:
```
voltage = voltage_raw * 0.02  # V (20mV/LSB)
```

### 0x290 - 蓄電池狀態
**用途**: 蓄電池系統狀態監測
**格式**: Little-endian
**資料長度**: 8 bytes

| 字節位置 | 數據類型 | 描述 | 係數 | 單位 | 範圍 |
|---------|---------|------|------|------|------|
| 0 | uint8 | 狀態標誌 | - | - | 0=Bad, 1=OK |
| 1-2 | int16 | 溫度 | 0.125 | °C | ±4096 |
| 3-4 | uint16 | 電壓 | 1/1024 | V | 0-64 |

**解碼公式**:
```
status = "OK" if status_raw == 1 else "BAD"
temperature = temp_raw * 0.125  # °C
voltage = voltage_raw / 1024.0  # V
```

### 0x390 - 蓄電池溫度
**用途**: 蓄電池溫度監測
**格式**: Little-endian
**資料長度**: 8 bytes

| 字節位置 | 數據類型 | 描述 | 係數 | 單位 | 範圍 |
|---------|---------|------|------|------|------|
| 0 | uint8 | 溫度感測器索引 | 1 | - | 0-255 |
| 1-7 | uint8 | 溫度值 | 0.5 | °C | 0-127.5 |

**解碼公式**:
```
temperature = temp_raw * 0.5  # °C (0.5°C/LSB)
```

### 0x490 - 蓄電池狀態資訊
**用途**: SOC、電流、容量監測
**格式**: Little-endian
**資料長度**: 8 bytes

| 字節位置 | 數據類型 | 描述 | 係數 | 單位 | 範圍 |
|---------|---------|------|------|------|------|
| 0 | uint8 | SOC (電量百分比) | 1 | % | 0-100 |
| 1-2 | int16 | 電流 | 0.01 | A | ±327.67 |
| 3-4 | int16 | 容量 | 0.01 | Ah | ±327.67 |

**解碼公式**:
```
soc = soc_raw  # %
current = current_raw * 0.01  # A (10mA/LSB)
capacity = capacity_raw * 0.01  # Ah (10mAh/LSB)
```

### 0x710 - 蓄電池心跳
**用途**: 蓄電池系統通訊狀態
**格式**: Little-endian
**資料長度**: 1 byte

| 字節位置 | 數據類型 | 描述 | 值 | 含義 |
|---------|---------|------|-----|------|
| 0 | uint8 | 心跳信號 | 0x7F | 正常 |
| 0 | uint8 | 心跳信號 | 其他 | 異常 |

---

## 逆變器系統協議

### 0x191-0x194 - 逆變器狀態
**用途**: 四個逆變器的運行狀態 (FL/FR/RL/RR)
**格式**: Little-endian
**資料長度**: 8 bytes

| 字節位置 | 數據類型 | 描述 | 係數 | 單位 | 範圍 |
|---------|---------|------|------|------|------|
| 0-1 | uint16 | 狀態字 | - | - | 0x0000-0xFFFF |
| 2-3 | int16 | 回饋扭矩 | 0.001 | 額定扭矩 | ±32.767 |
| 4-5 | int16 | 轉速 | 1 | RPM | ±32767 |

**逆變器映射**:
- 0x191: FL (前左)
- 0x192: FR (前右)
- 0x193: RL (後左)
- 0x194: RR (後右)

**解碼公式**:
```
feedback_torque = feedback_torque_raw / 1000.0
speed_rpm = speed_raw
```

### 0x291-0x294 - 逆變器電源狀態
**用途**: 四個逆變器的電源狀態
**格式**: Little-endian
**資料長度**: 8 bytes

| 字節位置 | 數據類型 | 描述 | 係數 | 單位 | 範圍 |
|---------|---------|------|------|------|------|
| 0-1 | uint16 | 直流電壓 | 0.01 | V | 0-655.35 |
| 2-3 | uint16 | 直流電流 | 0.01 | A | 0-655.35 |

**解碼公式**:
```
dc_voltage = dc_voltage_raw / 100.0  # V
dc_current = dc_current_raw / 100.0  # A
```

### 0x391-0x394 - 逆變器溫度
**用途**: 四個逆變器的溫度監測
**格式**: Little-endian
**資料長度**: 8 bytes

| 字節位置 | 數據類型 | 描述 | 係數 | 單位 | 範圍 |
|---------|---------|------|------|------|------|
| 0-1 | int16 | 逆變器MOS溫度 | 0.1 | °C | ±3276.7 |
| 2-3 | int16 | MCU溫度 | 0.1 | °C | ±3276.7 |
| 4-5 | int16 | 馬達溫度 | 0.1 | °C | ±3276.7 |

**解碼公式**:
```
mos_temp = mos_temp_raw * 0.1  # °C
mcu_temp = mcu_temp_raw * 0.1  # °C
motor_temp = motor_temp_raw * 0.1  # °C
```

### 0x711-0x714 - 逆變器心跳
**用途**: 四個逆變器的通訊狀態
**格式**: Little-endian
**資料長度**: 1 byte

| 字節位置 | 數據類型 | 描述 | 值 | 含義 |
|---------|---------|------|-----|------|
| 0 | uint8 | 心跳信號 | 0x7F | 正常 |
| 0 | uint8 | 心跳信號 | 其他 | 異常 |

---

## 數據來源說明

### 當前系統限制
- **GPS資料來源**: NavSatFix (/fix) - 提供座標和高度
- **速度資料來源**: TwistStamped (/vel) - 提供線性和角速度
- **缺失感測器**: IMU加速度計、航向感測器

### 預設值處理
當感測器資料不可用時，系統會設定以下預設值：
- 航向角: 0°
- 加速度: 0g (所有軸)
- 衛星數量: 8 (預設值)

---

## 開發者注意事項

1. **字節序**: 所有多字節數據均使用Little-endian格式
2. **數據類型**: 
   - uint8: 8位無符號整數
   - uint16: 16位無符號整數
   - int16: 16位有符號整數
   - uint32: 32位無符號整數
   - int32: 32位有符號整數
3. **錯誤處理**: 解碼器包含完整的異常處理機制
4. **擴展性**: 協議設計支持未來感測器的增加

---

## 更新日誌

- **v1.0** (2025-07-17): 初始版本，包含完整的CAN協議文檔
- 支援Ecumaster GPS格式
- 增加擴展速度和角速度資料
- 完整的蓄電池和逆變器監測協議
